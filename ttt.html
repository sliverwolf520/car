<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>è»Šç¦è¿½è¹¤ç¶²é </title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />

    <style>
        * { box-sizing: border-box; }
        body { font-family: Arial, sans-serif; margin: 0; padding: 20px; }
        .container { display: flex; gap: 20px; flex-wrap: wrap; }
        .form-section { width: 100%; max-width: 400px; }
        .form-section label { display: block; margin-bottom: 10px; }
        .form-section input { width: 100%; padding: 8px; margin-bottom: 15px; }
        .form-section button { padding: 10px 20px; font-size: 16px; }
        #distance { margin-top: 10px; font-weight: bold; }
        #map { flex: 1; min-width: 400px; height: 600px; }
    </style>
</head>
<body>

<h2>ğŸš¨ è»Šç¦ä½ç½®è¿½è¹¤ç³»çµ±</h2>

<div class="container">
    <!-- å·¦é‚Šè¼¸å…¥è¡¨å–® -->
    <div class="form-section">
        <label>ç¾åœ¨ä½ç½®ç·¯åº¦ï¼š<input type="number" step="any" id="lat1" placeholder="è‡ªå‹•å¡«å…¥"></label>
        <label>ç¾åœ¨ä½ç½®ç¶“åº¦ï¼š<input type="number" step="any" id="lng1" placeholder="è‡ªå‹•å¡«å…¥"></label>
        <label>è»Šç¦ç·¯åº¦ï¼š<input type="number" step="any" id="lat2" placeholder="Firebase è‡ªå‹•æ›´æ–°"></label>
        <label>è»Šç¦ç¶“åº¦ï¼š<input type="number" step="any" id="lng2" placeholder="Firebase è‡ªå‹•æ›´æ–°"></label>

        <button onclick="showOnMap()">é¡¯ç¤ºä½ç½®èˆ‡è·¯ç·š</button>
        <p id="distance"></p>

        <!-- æ”¯æ´éœ€æ±‚å€å¡Š -->
        <h3>ğŸš¨ éœ€è¦çš„æ”¯æ´</h3>
        <p>å ±è­¦ï¼š<span id="need_report">è¼‰å…¥ä¸­...</span></p>
        <p>æ•‘è­·è»Šï¼š<span id="need_ambulance">è¼‰å…¥ä¸­...</span></p>
        <p>æ¶ˆé˜²è»Šï¼š<span id="need_fire_truck">è¼‰å…¥ä¸­...</span></p>
    </div>

    <!-- å³é‚Šåœ°åœ– -->
    <div id="map"></div>
</div>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/10.13.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.13.2/firebase-database-compat.js"></script>

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<script>
    // ========== ğŸ”¹ Firebase åˆå§‹åŒ– ==========
    const firebaseConfig = {
        apiKey: "AIzaSyDJ5_v1fwboIfwTRLoS1NnDMkOj8LQcCCU",
        authDomain: "esp32-83d59.firebaseapp.com",
        databaseURL: "https://esp32-83d59-default-rtdb.firebaseio.com",
        projectId: "esp32-83d59",
        storageBucket: "esp32-83d59.firebasestorage.app",
        messagingSenderId: "312257620869",
        appId: "1:312257620869:web:53d35c84d801de75f2b2ec",
        measurementId: "G-GK6156PXKF"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // ========== ğŸ”¹ Leaflet åœ°åœ–è¨­å®š ==========
    const apiKey = 'eyJvcmciOiI1YjNjZTM1OTc4NTExMTAwMDFjZjYyNDgiLCJpZCI6ImQxMjMyNjg0NzVjZDQ0MTE5YjE1M2ViYmVlZDMyYTc1IiwiaCI6Im11cm11cjY0In0=';

    let map = L.map('map').setView([25.04, 121.56], 12);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    let userMarker, marker1, marker2, routeLine;

    // ========== ğŸ”¹ é¡¯ç¤ºè·¯ç·šå‡½å¼ ==========
    async function showOnMap() {
        const lat1 = parseFloat(document.getElementById("lat1").value);
        const lng1 = parseFloat(document.getElementById("lng1").value);
        const lat2 = parseFloat(document.getElementById("lat2").value);
        const lng2 = parseFloat(document.getElementById("lng2").value);

        if (isNaN(lat1) || isNaN(lng1) || isNaN(lat2) || isNaN(lng2)) {
            alert("è«‹è¼¸å…¥æœ‰æ•ˆçš„ç¶“ç·¯åº¦æ•¸å€¼");
            return;
        }

        if (marker1) map.removeLayer(marker1);
        if (marker2) map.removeLayer(marker2);
        if (routeLine) map.removeLayer(routeLine);

        marker1 = L.marker([lat1, lng1]).addTo(map).bindPopup("ç¾åœ¨ä½ç½®").openPopup();
        marker2 = L.marker([lat2, lng2]).addTo(map).bindPopup("è»Šç¦åœ°é»");

        try {
            const response = await fetch('https://api.openrouteservice.org/v2/directions/driving-car/geojson', {
                method: 'POST',
                headers: {
                    'Authorization': apiKey,
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ coordinates: [[lng1, lat1], [lng2, lat2]] })
            });

            if (!response.ok) throw new Error("API å›æ‡‰éŒ¯èª¤");

            const data = await response.json();
            const coords = data.features[0].geometry.coordinates.map(c => [c[1], c[0]]);

            routeLine = L.polyline(coords, { color: 'blue' }).addTo(map);
            map.fitBounds(routeLine.getBounds(), { padding: [50, 50] });

            const distance = (data.features[0].properties.summary.distance / 1000).toFixed(2);
            const duration = (data.features[0].properties.summary.duration / 60).toFixed(1);
            document.getElementById("distance").innerText =
                `æ±½è»Šè·¯ç·šè·é›¢ï¼šç´„ ${distance} å…¬é‡Œï¼Œé ä¼°æ™‚é–“ï¼šç´„ ${duration} åˆ†é˜`;
        } catch (err) {
            alert("æŸ¥è©¢è·¯ç·šæ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š" + err.message);
        }
    }

    // ========== ğŸ”¹ Firebase å¯¦æ™‚æ›´æ–° ==========
    const crashRef = db.ref("crash_report");
    crashRef.on("value", (snapshot) => {
        const data = snapshot.val();
        if (data) {
            // æ›´æ–°è»Šç¦ä½ç½®
            if (data.latitude !== undefined) document.getElementById("lat2").value = data.latitude;
            if (data.longitude !== undefined) document.getElementById("lng2").value = data.longitude;

            // æ›´æ–°éœ€è¦çš„æ”¯æ´
            document.getElementById("need_report").innerText = data.report ? "éœ€è¦" : "ä¸éœ€è¦";
            document.getElementById("need_ambulance").innerText = data.ambulance ? "éœ€è¦" : "ä¸éœ€è¦";
            document.getElementById("need_fire_truck").innerText = data.fire_truck ? "éœ€è¦" : "ä¸éœ€è¦";
        }
    });

    // ========== ğŸ”¹ å–å¾—ä¸¦é¡¯ç¤ºä½¿ç”¨è€…ä½ç½® ==========
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition((pos) => {
            const lat = pos.coords.latitude;
            const lng = pos.coords.longitude;
            document.getElementById("lat1").value = lat.toFixed(6);
            document.getElementById("lng1").value = lng.toFixed(6);

            // åœ¨åœ°åœ–ä¸Šé¡¯ç¤ºä½¿ç”¨è€…ä½ç½®
            if (userMarker) map.removeLayer(userMarker);
            userMarker = L.marker([lat, lng]).addTo(map).bindPopup("æ‚¨çš„ä½ç½®").openPopup();

            // åœ°åœ–ä¸­å¿ƒç§»åˆ°ä½¿ç”¨è€…ä½ç½®
            map.setView([lat, lng], 14);
        }, (err) => { console.warn("ç„¡æ³•å–å¾—ä½ç½®ï¼š", err.message); });
    } else {
        alert("æ‚¨çš„ç€è¦½å™¨ä¸æ”¯æ´å®šä½åŠŸèƒ½");
    }
</script>

</body>
</html>
